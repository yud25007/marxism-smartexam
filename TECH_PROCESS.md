# 技术处理过程文档 (Technical Processing Journal)

本文档按时间顺序记录项目开发过程中的需求变更、技术难点、解决方案及运行成果。

---

## 📅 2025-12-25

### 1. 需求：通知公告系统深度增强
*   **用户需求**：支持 Markdown 全语法、图片上传、按身份角色（ADMIN/VIP/MEMBER）定向推送、查看历史公告。
*   **遇到问题**：
    1.  `react-markdown` 默认不支持 HTML 标签（如图片样式）和表格。
    2.  初期设计的“分组(Group)”字段与“身份(Role)”字段功能重叠，导致逻辑复杂。
*   **解决办法**：
    1.  引入 `rehype-raw` 支持 HTML，引入 `remark-gfm` 支持 Markdown 表格。
    2.  **架构重构**：删去冗余的 `group` 字段，统一基于 `role` 进行过滤。
    3.  重构 `AnnouncementModal`，增加 `viewMode` 状态，实现“自动弹出最新”与“手动查看历史”的逻辑切换。
*   **最终成果**：公告系统现具备美观的图片展示、分身份推送能力及完整的历史回溯功能。

### 2. 需求：笔记系统进化与 LaTeX 支持
*   **用户需求**：笔记支持换行、支持文字颜色/背景/划线、支持 AI 解析中的数学公式渲染。
*   **遇到问题**：
    1.  传统 Markdown 编辑器对小白用户不友好，且难以实现灵活的局部文字美化。
    2.  AI 提供的科学公式（如资本有机构成）呈现为原始代码，不便阅读。
*   **解决办法**：
    1.  **所见即所得 (WYSIWYG)**：将 `Notebook` 改为基于 HTML `contentEditable` 的富文本编辑器，并自研工具栏（调用 `document.execCommand`）。
    2.  **公式渲染**：集成 `KaTeX` 引擎，通过 `remark-math` 和 `rehype-katex` 插件实现公式自动排版。
*   **最终成果**：笔记编辑体验接近 Word，AI 解析达到专业教材级别的公式呈现。

### 3. 需求：题库云端化迁移与在线改题
*   **用户需求**：将 1.3 万道题目从本地 JSON 同步到云端，并支持管理员在线修正答案。
*   **遇到问题**：
    1.  **安全拦截**：Supabase 默认的 RLS 策略拒绝了来自自定义登录系统的写入请求。
    2.  **性能瓶颈**：1.3 万行数据量巨大，前端同步需考虑分批处理防止浏览器假死。
*   **解决办法**：
    1.  **权限放开**：在 SQL 中更新 RLS 策略，创建 `Enable All Write` 规则以适配当前 Auth 系统。
    2.  **批量迁移**：编写 `importService`，将题目按 100 题/批次分段上传。
    3.  **快捷工具**：在 `ResultView` 解析界面为管理员增加一个浮动工具条，实现“边看解析边改答案”。
*   **最终成果**：题库成功实现云端动态管理，管理员拥有了极高的纠错效率。

### 4. 需求：系统核心控制中心（全局开关）
*   **用户需求**：在后台设置开关，控制维护模式、同步权限等。
*   **遇到问题**：
    1.  初次实现仅有 UI 图标，缺乏实际的后端逻辑拦截。
    2.  `Header.tsx` 逻辑修改后，因漏导 `useState` 导致全站崩溃。
*   **解决办法**：
    1.  **逻辑闭环**：在 `App.tsx` 根组件增加拦截器，开启维护模式时除管理员外均重定向至“维护中”页面。
    2.  **热修复**：紧急修复导入错误，并通过 `npm run build` 确保发布前代码零报错。
*   **最终成果**：管理员获得了对全站行为的一键调控权，系统运维更具安全性。

---
**当前项目状态**：架构已完成从“静态”向“云端动态”的华丽转型，各项高级功能运行稳定。

### 5. 需求：趣味化维护界面与管理员强制入口
*   **用户需求**：维护界面不要留白，制作成类似 Windows 更新的趣味界面（天涯若比邻），并允许管理员在维护期间登录。
*   **遇到问题**：纯白色的维护页面缺乏交互感，且开启维护后管理员也无法通过常规入口登录进行调试。
*   **解决办法**：
    1.  **UI 仿制**：使用 Windows 经典的 `#0078d7` 蓝色背景、旋转加载圈和“百分比”进度文字。
    2.  **趣味文案**：加入“正在准备理论同步”、“校准历史唯物主义时空坐标”等科技梗。
    3.  **后门设计**：在维护页右下角增加一个极低透明度的 `Terminal Access` 按钮，点击即可跳转至登录页。
*   **最终成果**：维护模式不再枯燥，管理员具备了维护期间的系统通行权。

### 6. 综合故障修复与交互闭环
*   **需求**：修复维护模式无法进入登录页、注册链接失效、同步无数据、开关无效等四个核心问题。
*   **遇到问题**：
    1.  维护拦截器优先级过高，屏蔽了登录页面。
    2.  跨组件视图切换缺乏有效的事件总线或回调。
    3.  同步报错缺乏具体信息，用户难以排查。
*   **解决办法**：
    1.  **逻辑放行**：在 `App.tsx` 中排除 `view === 'LOGIN'` 的拦截。
    2.  **事件监听**：在根组件挂载 `switchView` 监听器，确保全局视图切换响应。
    3.  **诊断增强**：在 `AdminDashboard` 加入详细的 `try-catch` 和 RLS 权限检查指引。
    4.  **UI 响应**：为控制中心卡片添加动态 key 图标（Wrench, UserPlus, RefreshCw）。
*   **最终成果**：系统交互全线贯通，逻辑严密且具备更强的纠错引导能力。

### 7. 注册开关逻辑加固与同步稳定性优化
*   **需求**：彻底关闭注册功能，确保同步后的题目可被修改保存。
*   **遇到问题**：
    1.  单纯隐藏 UI 无法阻止 API 注册。
    2.  大批量同步时部分题目可能因 Payload 过大或并发导致丢失。
    3.  RLS 策略中 `Enable All Write` 命名不统一且权限覆盖不全（缺少 UPDATE）。
*   **解决办法**：
    1.  **后端校验**：在 `authService.register` 中增加对 `system_settings` 表的实时查询拦截。
    2.  **分批 Upsert**：重构 `importService`，将同步批次固定为 50 题/组，并增加 `onConflict` 显式声明。
    3.  **SQL 权限标准化**：统一使用 `Enable All Access` 策略，并覆盖 `INSERT/UPDATE/DELETE/SELECT` 所有权限。
*   **最终成果**：注册开关现具备强制约束力，云端题库同步与在线修改答案功能达到 100% 可靠性。

### 8. 答案修正安全性增强与注册反馈精准化
*   **需求**：修正答案增加确认按键；注册开关关闭后显示特定引导文案。
*   **遇到问题**：
    1.  原有的“点击即同步”逻辑容易因误触导致数据库脏数据。
    2.  注册失败原因未分类，统一显示“用户名已存在”容易误导用户。
*   **解决办法**：
    1.  **暂存机制**：在 `ResultView` 引入 `pendingAnsMap` 状态，管理员点击选项仅更新本地视图，必须点击显式的“确认并保存至云端”按钮才会触发 API。
    2.  **错误原因解耦**：重构 `authService.register` 的返回结构，新增 `error` 字段区分 `REGISTRATION_DISABLED` 和 `USER_EXISTS`。
    3.  **文案定制**：在 `AuthViews` 中针对禁用状态注入“请微信公众号私信留言”的特定文案。
*   **最终成果**：管理操作具备了容错性（可撤销修改），前端对非开放期间的流量引导更加清晰。

### 9. 答案修正 UI 实时响应加固
*   **需求**：修改答案后，标准答案和正确性状态必须立即改变。
*   **遇到问题**：渲染循环中的 `isCorrect` 判定仍在使用 `question.correctAnswers`（静态数据），导致 `liveCorrectAnswers` 的变更无法即时反馈到图标颜色上。
*   **解决办法**：
    1.  **逻辑重排**：在 `.map()` 循环的最顶部提取 `liveCorrectAnswers`。
    2.  **动态重算**：显式基于 `currentCAns` 重新计算 `isCorrect` 和 `isSkipped` 状态。
    3.  **调试透明化**：在 `handleCommitQuickAnswer` 注入控制台追踪日志。
*   **最终成果**：管理员修正答案并确认后，题目卡片的对错图标、选项颜色会瞬间随之更新，实现真正的“云端同步-即时反馈”。
