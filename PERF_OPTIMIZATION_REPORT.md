# 🚀 马原题库项目性能优化方案与执行总结报告

## 1. 优化背景
针对生产环境 `https://marx.zeabur.app/` 在国内移动端及 PC 端直连加载极慢（LCP 超过 10s，甚至分钟级）的问题，我们实施了一套深度工程化优化方案，旨在通过减少包体积、加速资源下发和屏蔽海外数据库延迟来提升用户体验。

---

## 2. 核心诊断结果
*   **资源阻塞**：原本所有题目（1.3万道，约 436KB）同步打包在主 JS 中，导致单一包体积过大。
*   **网络阻断**：Google Fonts 和 KaTeX 的原始 CDN 在国内访问极度不稳定，导致渲染线程被挂起。
*   **数据库时延**：所有用户进入首页均触发海外 SQL 查询，产生了 500ms+ 的 TTFB 延迟。

---

## 3. 实施策略总结

### 🏗️ 构建层：极致分包 (Code Splitting)
*   **数据解耦**：在 `vite.config.ts` 中配置 `manualChunks`，将庞大的静态题库 `cloud_data.ts` 从主逻辑中剥离，生成独立的 `data-cloud.js`。
*   **第三方库拆分**：将 `recharts`、`lucide-react`、`react-markdown` 等重型依赖拆分为独立 vendor 包。
*   **压缩增强**：启用 `vite-plugin-compression`，对所有产物进行 Gzip 压缩，将 436KB 的题目数据压缩至约 42KB。

### 🌐 传输层：资源镜像与非阻塞加载
*   **CDN 替换**：
    *   Google Fonts ➔ `fonts.loli.net`（国内极速镜像）
    *   KaTeX CSS ➔ `lib.baomitu.com`（360 镜像）
*   **非阻塞渲染**：
    *   为 Tailwind CDN 脚本添加 `defer` 属性，允许浏览器先执行 HTML 解析。
    *   优化 `index.html` 头部，添加 `preconnect` 指令预先建立 DNS 连接。

### 🧠 逻辑层：SQL 访问特权化
*   **访客加速逻辑**：
    *   **普通用户**：完全屏蔽对 Supabase SQL 的实时查询，强制读取预编译好的静态包（秒开）。
    *   **管理员**：仅在检测到 ADMIN 角色时才建立 SQL 连接，保留在线改题和同步的能力。
*   **成果**：减少了 90% 以上的用户与海外服务器的握手次数。

### 🛠️ 容错层：自愈式骨架屏
*   **监控逻辑**：在 HTML 中注入轻量级监控脚本，检测 React 挂载状态。
*   **超时解锁**：若 JS 因网络极慢在 15-30s 内未加载，自动移除 Loading 遮罩层，防止用户卡死在全白界面。

---

## 4. 结果分析与回退原因
**尽管执行了上述方案，但在国内弱网环境下的首屏“感知速度”提升仍不明显，原因分析如下：**

1.  **物理带宽限制**：Zeabur 服务器对中国大陆的下行带宽存在上限，无论如何分包，总资源量（约 1.5MB 原始数据）的物理下载耗时在限速状态下是不可逾越的。
2.  **TCP 并发开销**：分包过多（Chunk 数增加）在弱网（4G/5G 切换）环境下会导致 TCP 频繁建立连接，产生的握手开销抵消了分包带来的并行优势。
3.  **CDN 节点漂移**：国内部分公共镜像源在不同运营商（电信/联通/移动）下的解析稳定性不一，偶发 404 导致公式无法显示。

---

## 5. 后续建议方案
如果需要彻底解决国内访问速度，单靠前端工程优化已达瓶颈，建议考虑：
1.  **节点迁移**：将静态资源部署至国内对象存储（如阿里云 OSS + CDN）。
2.  **SSR/SSG 方案**：切换为 Next.js 框架进行服务端预渲染，减少首屏 JS 依赖。
3.  **内网穿透/代理**：使用具有国内加速链路的反向代理服务器。

---
**项目状态说明**：
*已根据用户指令，通过 `git reset --hard` 将所有优化变动撤销，代码目前已恢复至版本 `f592cce`。*
